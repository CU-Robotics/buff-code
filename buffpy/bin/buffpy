#! /usr/bin/env python3
"""
	Project: BuffPy
	author: Mitchell D Scott
	Description:
	  This is a python3 command line tool from CU-Robotics
	It is meant to simplify development of robotics software.
	Think of buff-code as a python3 app that handles the backend
	of software development:
	 - installing/setting up devices
	 - handling data
	 - testing

	  The goal is to eliminate the need for engineers to work on
	the workspace and allow them to focus on the algorithms 
	that drive the robot.

	TODO:
		debug and test all functionality (this script is woefully untested
		and will likely brake, even with standard input).

		make functionality more robust to erraneous input and general brake downs.

	NOTES:
		This program only really works once the workspace has been built.
		Which happens with the install. -- Removed GDrive_handler to fix this
"""

import os
import sys
import yaml
import shutil
import argparse
import subprocess


def clear_directory(path):

	# Idoit Security
	# this function could wipe the entire disk
	# if not used with caution. (its also very easy for an attacker to change an environment variable)
	if len(path.split('/')) < 3:
		print(f'Illegal Directory: cannot remove {path}')
		return

	# Remove all lib files, these are installed by catkin
	# By walking through each dir and removing its files
	# we can then delete the directories
	if os.path.exists(path):
		for root, dirs, files in os.walk(path):
			for file in files:
				os.remove(os.path.join(root, file))
			for directory in dirs:
				shutil.rmtree(os.path.join(root, directory))
			break
	else:
		os.mkdir(path)


def cleanWorkspace():
	"""
		Removes the data folder, and when it becomes necesary
		will also remove any generated binaries and configs
	"""
	data_path = os.path.join(os.getenv('PROJECT_ROOT'), 'data')
	lib_path = os.path.join(os.getenv('PROJECT_ROOT'), 'buffpy', 'lib')

	if not 'edge' in os.getenv('HOSTNAME'):
		result = subprocess.run(f'catkin clean -y', shell=True)

	clear_directory(data_path)
	clear_directory(lib_path)


def buildWorkspace(build):
	"""
		Builds the current workspace locally or to a robot.
		this will need to copy python files and binaries to the robot.
		@PARAMS:
			build: the profile to build
		@RETURNS:
			None
	"""
	# use catkin to clean the workspace if it was already built
	result = subprocess.run(f'catkin clean -y', shell=True)
	# clean the lib when building
	clear_directory(os.path.join(os.getenv('PROJECT_ROOT'), 'buffpy', 'lib'))

	# Rebuild the workspace with catkin build
	if build[0]:
		result = subprocess.run(f'catkin build --profile={build[0]}', shell=True)

	else:
		print('No profile specified exiting:...')


def get_devices():
	# load all registered devices
	config = os.path.join(os.getenv('PROJECT_ROOT'), 'buffpy', 'config', 'robots', 'robots.yaml')
	if os.path.exists(config):
		with open(config, 'r') as f:
			return yaml.safe_load(f)


def install_ssh_keys():

	devices = get_devices()
	home = os.getenv('HOME')
	if not os.path.exists(f'{home}/.ssh/id_ed25519.pub'):
		result = subprocess.run(['ssh-keygen', '-t', 'ed25519'])

	for robot in devices:
		botAddress = f'cu-robotics@{robot}'
		try:
			result = subprocess.run(['ssh', botAddress, f'if [[ ! -f /home/cu-robotics/.ssh/id_ed25519.pub ]]; then ssh-keygen -t ed25519; fi'], timeout=10)
			if result.returncode == 0:
				result = subprocess.run(['ssh-copy-id', '-i', f'{home}/.ssh/id_ed25519.pub', botAddress])
				if result.returncode == 0:
					print(f'{robot} Success')

		except subprocess.TimeoutExpired:
			print(f'{robot} Timed out')


def install_buffpy(botAddress, source, target, ID, botType):
	""" Install buffpy to a bot over scp
	"""

	with open(ID, 'w+') as f:
		f.write(f"FROM:\n  '{botType}.yaml'\n")
	# if root does exist remove it
	try:	
		cleanDir_result = subprocess.run(['ssh', botAddress, f'if [[ -d {target} ]]; then rm -rf {target}; fi; mkdir {target}'], timeout=10)
		if cleanDir_result.returncode == 0:
			install_result = subprocess.run(['scp', '-r', source, f'{botAddress}:{target}'])
			print(install_result)

			return install_result.returncode
				
	except subprocess.TimeoutExpired:
		print(f'{botAddress} Timed out')

	return 1


def install_all_devices():
	"""
		Install all built code to all robots
	"""

		# Setup Parameters for install
	target = os.path.join('/home', 'cu-robotics', 'buff-code')
	project_root = os.getenv('PROJECT_ROOT')
	source = os.path.join(project_root, 'buffpy')
	ID = os.path.join(project_root, 'buffpy', 'config', 'robots', 'self.yaml')

	if len(os.listdir(os.path.join(source, 'lib'))) == 0:
		print("Workspace not built, run: /'buffpy --build <profile>/'")
		return

	# Don't build on edge devices (robot)
	if 'edge' in os.getenv('HOSTNAME'):
		print(f"Can/'t build on device: {os.getenv('HOSTNAME')}")
		return

	devices = get_devices()

	for robot in devices:
		botType = devices[robot]

		# set target destination
		botAddress = f'cu-robotics@{robot}'

		install_buffpy(botAddress, source, target, ID, botType)


def initialize_devices():

		# Setup Parameters for initializing
	target = os.path.join('/home', 'cu-robotics', 'buff-code')
	project_root = os.getenv('PROJECT_ROOT')
	source = os.path.join(project_root, 'buffpy')
	ID = os.path.join(project_root, 'buffpy', 'config', 'robots', 'self.yaml')

	if len(os.listdir(os.path.join(source, 'lib'))) == 0:
		print("Workspace not built, run: /'buffpy --build <profile>/'")
		return

	# Don't build on edge devices (robot)
	if 'edge' in os.getenv('HOSTNAME'):
		print(f"Can/'t build on device: {os.getenv('HOSTNAME')}")
		return

	devices = get_devices()

	for robot in devices:
		botType = devices[robot]

		# set target destination
		botAddress = f'cu-robotics@{robot}'
		if install_buffpy(botAddress, source, target, ID, botType) != 0:
			continue
		try:
			setup_result = subprocess.run(['ssh', 
					'-t',
					botAddress, 
					f'cd /home/cu-robotics/buff-code; \
					source buffpy/scripts/install.bash'])

		except subprocess.TimeoutExpired:
			print(f'{botAddress} Timed out')


def diagnostic():
	print(f'\n\tBuffPy Diagnostic Running...\n')
	try:
		import cv2			# Test opencv-python import
		print(f'cv2 import success')
		import yaml			# Test pyyaml import
		print(f'yaml import success')
		import torch		# Test pytorch import
		print(f'torch import success')
		import numpy		# Test numpy import
		print(f'numpy import success')
		import rospy		# Test rospy import
		print(f'rospy import success')
		import pydrive 		# Test pydrive import
		print(f'pydrive import success')

		if cv2.__version__ != '4.5.5':
			print(f'Open-CV version mis-match: {cv2.__version__} != 4.5.5')
		if yaml.__version__ != '6.0':
			print(f'PyYaml version mis-match: {yaml.__version__} != 6.0')
		if not '1.9.0' in torch.__version__:
			print(f'PyTorch version mis-match: {torch.__version__} != 1.9.0*')

		print(f'\n\tDiagnostic Successful\n')

	except Exception as e:
		print(e)


def parseArgs():
	"""
		Handles parsing all inputs to buff
		@PARAMS
			None
		@RETURNS
			parsedargs: argparse args object
	"""
	parser = argparse.ArgumentParser(prog=sys.argv[0],
	description='CU-Robotics Multi-Agent Deployment Manager')
	parser.add_argument('--installKeys',
		action='store_true',
		help='Push local sshkeys to the robots')
	parser.add_argument('--launch', 
		nargs=1,
		metavar='LOCATION',
		default=False,
		help='Launch the robots software on robots')
	parser.add_argument('--botPull', 
		action='store_true',
		help='Pull data from the robot at ROBOT_IP')
	parser.add_argument('--build', 
		nargs=1,
		metavar='PROFILE',
		default=False,
		help='Builds the workspace locally (debug) or to the robot_ip (install)')
	parser.add_argument('--install', 
		action='store_true',
		help='Installs build to the registered robots')
	parser.add_argument('--diagnostic', 
		action='store_true',
		help='Tests a workspace installation and tools')
	parser.add_argument('--initialize', 
		action='store_true',
		help='Initializes registered devices')
	parser.add_argument('--clean',
		action='store_true',
		help='Clean the current bin and data, NOT recoverable; only run this if you are sure you want to')

	return parser.parse_args(sys.argv[1:])
						

def main(ap):

	if ap.clean:
		cleanWorkspace()

	if ap.diagnostic:
		diagnostic()

	if ap.installKeys:
		install_ssh_keys()

	if ap.initialize:
		initialize_devices()

	if ap.build:
		buildWorkspace(ap.build)

	if ap.install:
		install_all_devices()

	# May be Deprecated
	if ap.launch == 'bot':
		result = subprocess.run(['ssh', os.getenv("ROBOT_ADDRESS"), 'cd buff-code && source buff.bash && launch'])

	if ap.botPull:
		result = subprocess.run(['scp', f'{os.getenv("ROBOT_ADDRESS")}:{os.getenv("ROBOT_ROOT")}/data', f'{os.getenv("PROJECT_ROOT")}/data'])

if __name__ == '__main__':
	ap = parseArgs()
	main(ap)

